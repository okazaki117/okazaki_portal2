# PROJECT_CONTEXT.md - 家族ポータル プロジェクト概要

> このファイルは、プロジェクトの全体像を把握するためのドキュメントです。
> 作業再開時に最初に読むファイルとして設計されています。

---

## 1. プロジェクトの目的

**家族2人（夫婦）専用の情報共有Webアプリ**

- 共有メモ、買い物リスト、年間目標などを2人で同期
- iPhoneのホーム画面に追加してネイティブアプリのように使う
- 家族以外には一切データを見せない設計

### なぜ自作するのか

- 既存アプリ（Notion、Google Keep等）は機能過多
- 家族だけのシンプルな共有空間が欲しい
- 自分たちに最適化したUIを作りたい

---

## 2. 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー端末                              │
│  ┌──────────────┐     ┌──────────────┐                         │
│  │ iPhone Safari │     │   PC Browser  │                         │
│  └──────┬───────┘     └──────┬───────┘                         │
└─────────┼────────────────────┼──────────────────────────────────┘
          │                    │
          ▼                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Pages (public)                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  index.html / app.js / styles.css / manifest.json          │ │
│  │  ※ 静的ファイルのみ。データは一切含まない                    │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │
          │ API リクエスト (HTTPS)
          │ ・通常: GET + URLパラメータ
          │ ・画像: POST + text/plain (CORS回避)
          ▼
┌─────────────────────────────────────────────────────────────────┐
│              Google Apps Script (Webアプリ)                     │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Code.gs                                                   │ │
│  │  ・doGet() / doPost() でリクエスト処理                      │ │
│  │  ・スプレッドシートへのCRUD操作                             │ │
│  │  ・Google Drive への画像保存/取得                           │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Google スプレッドシート                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  Memos   │ │  Wishes  │ │ Shopping │ │ Settings │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│  ※ 非公開。GAS経由でのみアクセス可能                            │
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Google Drive                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  トップ画像ファイル（限定公開）                              │ │
│  │  ※ fileId のみスプレッドシートに保存                        │ │
│  │  ※ GAS経由でBase64として取得・返却                          │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 技術スタック

| レイヤー | 技術 | 備考 |
|----------|------|------|
| フロントエンド | HTML / CSS / Vanilla JS | フレームワークなし。シンプル優先 |
| ホスティング | GitHub Pages | 無料、HTTPS自動、public repo |
| バックエンドAPI | Google Apps Script | 無料枠で十分、Googleアカウント認証不要で公開可 |
| データベース | Google スプレッドシート | 構造がシンプル、手動編集も可能 |
| 画像ストレージ | Google Drive | GAS経由でアクセス、限定公開のまま |
| PWA | manifest.json | ホーム画面追加対応 |

### 使用していない技術（意図的に避けている）

- React / Vue / Next.js → 過剰。ビルド不要にしたい
- Firebase → 将来検討中だが現時点では不要
- 認証機能 → URLを知らなければアクセス不可で十分

---

## 4. セキュリティ設計の考え方

### 基本方針：「URLを知らなければアクセスできない」

```
【公開範囲】
├─ GitHub Pages (index.html等)  → public（誰でも見れる）
├─ GAS WebアプリURL             → 知っている人のみ
├─ スプレッドシート             → 非公開（GAS経由のみ）
└─ Google Drive画像             → 非公開（GAS経由のみ）
```

### なぜこれで安全か

1. **GitHub Pagesにデータは一切ない**
   - HTMLとJSのみ。API URLはlocalStorageに保存
   - ソースを見られても、データにはアクセスできない

2. **GAS URLは推測困難**
   - `https://script.google.com/macros/s/AKfycbw.../exec`
   - ランダムな文字列で、総当たり攻撃は現実的でない

3. **スプレッドシートは非公開**
   - 共有設定を変更しない限り、オーナーのみアクセス可

4. **画像もGAS経由**
   - Google DriveのファイルURLは外部に露出しない
   - GASがプロキシとしてBase64で返却

### 注意点

- GAS URLを第三者に共有しない
- スプレッドシートの共有設定を変更しない
- 機密情報（パスワード等）はこのアプリで管理しない

---

## 5. iPhone Safari 固有の注意点

### 5.1 CORS / プリフライト問題

```
【問題】
Safari → GAS への POST リクエストで CORS エラー

【原因】
Content-Type: application/json は「単純リクエスト」ではないため、
プリフライト（OPTIONS）リクエストが発生。
GAS は OPTIONS に対応していない。

【解決策】
Content-Type: text/plain を使用（単純リクエスト扱い）
GAS側で JSON.parse(e.postData.contents) でパース
```

### 5.2 URL長制限

```
【問題】
Base64画像をGETパラメータに含めると、
Safari の URL 長制限（約2MB）を超えてリクエスト失敗

【解決策】
画像アップロードのみ POST + body で送信
通常のAPIは引き続き GET を使用（キャッシュ効率）
```

### 5.3 PWA関連

```
【ホーム画面追加時の注意】
- manifest.json のパスはすべて相対パス（./）で記述
- start_url も "./" にする（絶対パスだと404になることがある）
- アイコンは 192x192 と 512x512 の2サイズ用意
```

### 5.4 その他

- iOS 13以降はEXIF orientationを自動補正（回転処理不要）
- HEIC形式はSafariが自動でJPEG変換してくれる
- Canvas処理時はメモリ制限に注意（先にリサイズしてから処理）

---

## 6. ファイル構成

```
okazaki_portal/
├── index.html          # メインHTML（SPA、全画面をここに含む）
├── manifest.json       # PWAマニフェスト
├── css/
│   └── styles.css      # 全スタイル
├── js/
│   └── app.js          # 全JavaScript（v2.1）
├── gas/
│   └── Code.gs         # GASに貼り付けるコード
├── icons/
│   ├── icon.png        # アプリアイコン
│   └── icon.svg        # SVG版
├── SETUP.md            # セットアップ手順書
├── PROJECT_CONTEXT.md  # ← このファイル
├── CURRENT_STATUS.md   # 現在の状態・課題
└── RESUME_PROMPT.md    # 作業再開用プロンプト
```

---

## 7. 開発環境

| 項目 | 内容 |
|------|------|
| 開発PC | Windows |
| エディタ | Claude Code (CLI) |
| ブラウザ確認 | Chrome / Safari (iPhone実機) |
| GAS編集 | Google Apps Script エディタ（ブラウザ） |

---

## 8. 関連リソース（実際の値は SETUP.md 参照）

- **スプレッドシートID**: SETUP.md に記載
- **GAS WebアプリURL**: SETUP.md に記載
- **GitHub Pages URL**: リポジトリ設定に依存

---

> 最終更新: 2025年2月
> このファイルはプロジェクトの「地図」です。詳細は各ソースファイルを参照してください。
