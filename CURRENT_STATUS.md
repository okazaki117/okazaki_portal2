# CURRENT_STATUS.md - 現在の状態と課題

> このファイルは、プロジェクトの現在地を把握するためのドキュメントです。
> 作業再開時に「今何ができていて、何が残っているか」を確認するために使います。

---

## 1. 現在できている機能

### 1.1 ポータル画面（トップページ）

| 機能 | 状態 | 備考 |
|------|------|------|
| トップ画像表示 | ✅ 完了 | Google Drive から GAS 経由で取得 |
| トップ画像アップロード | ✅ 完了 | POST + text/plain、自動圧縮（1MB以下） |
| トップ画像削除 | ✅ 完了 | Drive のファイルをゴミ箱に移動 |
| ピン留めメモ表示 | ✅ 完了 | Memos シートから pinned=true を抽出 |
| アプリカード（4つ） | ✅ 完了 | メモ/やりたいこと/買い物/設定 |

### 1.2 共有メモ

| 機能 | 状態 | 備考 |
|------|------|------|
| メモ一覧表示 | ✅ 完了 | 新しい順にソート |
| メモ追加 | ✅ 完了 | Ctrl+Enter でも送信可 |
| ピン留め ON/OFF | ✅ 完了 | ポータルにも反映 |
| メモ削除 | ✅ 完了 | 論理削除（deleted=true） |

### 1.3 今年やりたいこと

| 機能 | 状態 | 備考 |
|------|------|------|
| 年ごとの一覧表示 | ✅ 完了 | 年選択ボタンで切り替え |
| 項目追加 | ✅ 完了 | Enter で送信 |
| ステータス変更 | ✅ 完了 | 未着手/進行中/完了 |
| コメント編集 | ✅ 完了 | prompt() で入力 |
| フィルター | ✅ 完了 | すべて/未着手/進行中/完了 |
| 項目削除 | ✅ 完了 | 論理削除 |

### 1.4 買い物リスト

| 機能 | 状態 | 備考 |
|------|------|------|
| 一覧表示 | ✅ 完了 | 買うもの/購入済みでタブ切り替え |
| アイテム追加 | ✅ 完了 | Enter で送信 |
| 購入済みチェック | ✅ 完了 | タップでトグル |
| アイテム削除 | ✅ 完了 | 論理削除 |

### 1.5 設定画面

| 機能 | 状態 | 備考 |
|------|------|------|
| API URL 入力・保存 | ✅ 完了 | localStorage に保存 |
| 接続テスト | ✅ 完了 | ping アクションで確認 |
| 設定クリア | ✅ 完了 | localStorage のみ削除 |
| セットアップ手順表示 | ✅ 完了 | 画面内に表示 |

### 1.6 PWA対応

| 機能 | 状態 | 備考 |
|------|------|------|
| ホーム画面追加 | ✅ 完了 | manifest.json 設定済み |
| フルスクリーン表示 | ✅ 完了 | display: standalone |
| アイコン | ✅ 完了 | 192x192 / 512x512 |

---

## 2. 未解決の課題

### 2.1 パフォーマンス関連

| 課題 | 深刻度 | 詳細 |
|------|--------|------|
| ~~初回読み込みが遅い~~ | ~~中~~ | ✅ v2.2でキャッシュ導入により改善 |
| 毎回全データ取得 | 低 | 差分取得はないが、キャッシュで体感改善 |
| 画像取得が遅い | 低 | キャッシュにより2回目以降は即表示 |

### 2.2 UX関連

| 課題 | 深刻度 | 詳細 |
|------|--------|------|
| オフライン非対応 | 低 | Service Worker 未実装 |
| プルトゥリフレッシュなし | 低 | 更新ボタンのタップが必要 |
| ローディング中の操作 | 低 | 連打すると重複リクエストの可能性 |

### 2.3 機能関連

| 課題 | 深刻度 | 詳細 |
|------|--------|------|
| メモ編集機能なし | 低 | 削除→再作成で対応中 |
| 画像の複数枚対応なし | 低 | トップ画像は1枚のみ |
| 検索機能なし | 低 | データ量が少ないため不要 |

---

## 3. パフォーマンス懸念点

### 3.1 スプレッドシートの限界

```
【現状】
- 毎回 sheet.getDataRange().getValues() で全行取得
- データ量が増えると線形に遅くなる

【予想される限界点】
- 数百行程度なら問題なし
- 1000行を超えると体感で遅くなる可能性

【家族利用での現実】
- メモ: 年間100件程度 → 問題なし
- 買い物: 常時10-20件 → 問題なし
- やりたいこと: 年間20件程度 → 問題なし
```

### 3.2 GAS の実行時間制限

```
【制限】
- 1回の実行: 最大6分
- 現状の処理: 数秒以内

【リスク】
- 画像アップロード時に大きすぎるファイル → タイムアウト
- 対策: フロントで1MB以下に圧縮済み
```

### 3.3 API呼び出し回数

```
【現状】
- ポータル表示: 2回（画像 + メモ）
- 各アプリ表示: 1回

【GAS の無料枠】
- 1日あたり 20,000 回
- 家族2人の利用では到底届かない
```

---

## 4. 今後やりたい改善項目

### Priority 1: 体感速度の改善（Firebase移行なし）

| 項目 | 効果 | 難易度 | 状態 |
|------|------|--------|------|
| ローカルキャッシュ導入 | 高 | 中 | ✅ **v2.2で実装済み** |
| 楽観的UI更新 | 中 | 低 | ✅ **v2.2で実装済み** |
| ローディングスケルトン | 中 | 低 | 未着手（優先度下げ） |

### Priority 2: 安定性向上

| 項目 | 効果 | 難易度 | 備考 |
|------|------|--------|------|
| リトライ処理 | 中 | 低 | 一時的なネットワークエラーへの対応 |
| エラーハンドリング強化 | 中 | 低 | より具体的なエラーメッセージ |
| 重複リクエスト防止 | 低 | 低 | ボタン連打対策 |

### Priority 3: 機能追加

| 項目 | 効果 | 難易度 | 備考 |
|------|------|--------|------|
| メモ編集機能 | 中 | 中 | インライン編集 or モーダル |
| プルトゥリフレッシュ | 低 | 中 | ネイティブアプリ感向上 |
| Service Worker | 低 | 高 | オフライン対応（優先度低） |

### Priority 4: Firebase 移行準備

| 項目 | 効果 | 難易度 | 備考 |
|------|------|--------|------|
| API層の抽象化 | - | 中 | GAS → Firebase 切り替えを容易に |
| データ構造の見直し | - | 中 | Firestore 向けの設計検討 |

---

## 5. 直近で完了した作業履歴

| 日付 | 内容 |
|------|------|
| 2025/02/08 | **v2.2.3: ポータル下部にバージョン表記追加** |
| 2025/02/08 | **v2.2.2: PWAモードでのヘッダー表示修正（セーフエリア対応）** |
| 2025/02/08 | **v2.2.1: キャッシュクリアボタンを分離（API URL保持）** |
| 2025/02/08 | **v2.2: ローカルキャッシュ導入（体感速度改善）** |
| 2025/02/08 | **v2.2: 楽観的UI更新（操作の即時反映）** |
| 2025/02/08 | 認証設計レビュー → パスワード認証は過剰と判断、見送り |
| 2025/02/08 | SETUP.md にGAS更新時の注意事項を追記 |
| 2025/02 | 画像アップロードを POST 化（Safari URL長制限対応） |
| 2025/02 | Content-Type: text/plain で CORS プリフライト回避 |
| 2025/02 | GAS 側 doPost で e.postData.contents 受信対応 |
| 2025/02 | フロントで画像自動圧縮（1MB以下） |
| 2025/02 | アイコン作成・manifest.json 調整 |

---

## 6. 次に着手すべき作業

```
【v2.2.1で実装済み】
✅ ローカルキャッシュの導入
✅ 楽観的UI更新
✅ キャッシュクリアボタン分離（API URL保持）

【残りの改善項目（優先度順）】

1. 実機テスト
   - iPhoneでキャッシュ動作を確認
   - 楽観的UI更新の体感を確認
   - キャッシュクリア後の再読み込み確認

2. 必要に応じて機能追加
   - メモ編集機能
   - プルトゥリフレッシュ
```

---

## 7. 開発時の注意点

### 7.1 GAS 更新時

```
1. Code.gs を編集
2. 「デプロイ」→「デプロイを管理」
3. 鉛筆アイコン → バージョン「新バージョン」
4. 「デプロイ」クリック
※ 新しいデプロイを作成すると URL が変わるので注意
```

### 7.2 フロントエンド更新時

```
1. js/app.js を編集
2. index.html の script タグのバージョンを更新
   <script src="./js/app.js?v=2.3"></script>  ← 数字を増やす
3. git push で GitHub Pages に反映
```

### 7.3 iPhone でのデバッグ

```
1. Mac の Safari で「開発」メニューを有効化
2. iPhone を Mac に接続
3. Safari「開発」→ iPhone 名 → ページ選択
4. Web インスペクタでコンソール確認
```

---

> 最終更新: 2025年2月8日
>
> **ルール**: 作業完了時は必ずこのファイルを更新すること。
