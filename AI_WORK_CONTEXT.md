# AI_WORK_CONTEXT.md

> **このファイルは、複数のAI（Claude Code / OpenAI Codex）が交互に作業する際の唯一の共通コンテキストです。**
> 作業開始時に必ず最初に読んでください。
>
> **最終責任者・意思決定者はユーザー（人間）です。** AIは判断材料の提示と作業の実行を担い、最終判断はすべてユーザーが行います。

---

## プロジェクト概要

- アプリ名: 家族ポータル
- リポジトリ: okazaki_portal2
- 目的: 夫婦2人専用のシンプルな情報共有PWA
- ホスティング: GitHub Pages（静的ファイルのみ。データは一切含まない）
- 現在のバージョン: v2.5.1

## 技術スタック

| レイヤー | 技術 | 補足 |
|----------|------|------|
| フロントエンド | HTML / CSS / Vanilla JS | フレームワーク不使用。ビルドツール不使用 |
| PWA | manifest.json | ホーム画面追加対応（standalone） |
| バックエンドAPI | Google Apps Script（Webアプリ） | doGet / doPost でリクエスト処理 |
| データ保存 | Google スプレッドシート | シート: Memos / Wishes / Shopping / Settings |
| 画像保存 | Google Drive | fileId をスプレッドシートに保存。GAS経由でBase64取得 |

## ファイル構成

```
okazaki_portal2/
├── index.html            # メインHTML（SPA。全画面をここに含む）
├── manifest.json         # PWAマニフェスト
├── js/app.js             # 全JavaScript
├── css/styles.css        # 全スタイル
├── gas/Code.gs           # GASに貼り付けるコード（このリポジトリ内はコピー）
├── icons/                # PWAアイコン
├── codex-tasks/          # Claude → Codex への作業指示書置き場
├── AI_WORK_CONTEXT.md    # ← このファイル（AI共通コンテキスト）
├── PROJECT_CONTEXT.md    # アーキテクチャ・設計方針の詳細
├── CURRENT_STATUS.md     # 実装状況・課題・作業履歴
├── SETUP.md              # セットアップ手順（スプレッドシートID等の実値あり）
└── RESUME_PROMPT.md      # AI向け再開用プロンプト集
```

## セキュリティモデル

- 認証機能はない（評価の結果、夫婦2人用途では過剰と判断し見送り済み）
- GitHub Pages上にデータは一切ない（HTML/CSS/JSのみ）
- GAS WebアプリURLを知っている人だけがデータにアクセスできる設計
- スプレッドシート・Google Driveは非公開（GAS経由でのみアクセス）

## iPhone Safari固有の技術制約

これらを知らずにコードを変更すると動作が壊れるため、必ず意識すること。

- **CORS回避**: POSTリクエストは `Content-Type: text/plain` を使用する（application/json はプリフライトが発生し、GASが対応できない）
- **画像アップロード**: 必ずPOSTで送信する（GETだとBase64がURL長制限を超える）
- **通常のAPI呼び出し**: GETを使用する（キャッシュ効率のため）
- **GAS側のPOST受信**: `e.postData.contents` を `JSON.parse` してパースする

---

## AI協業モデル

### 役割分担

| 担当 | 役割 | 具体的な作業内容 |
|------|------|-----------------|
| **人間（ユーザー）** | 方針決定・最終判断 | 要求の発行、方針の承認、本番反映の判断、最終責任 |
| **Claude Code** | 調査・設計・軽微な修正 | 調査、設計整理、仕様の言語化、全体レビュー、ドキュメント整備、影響範囲・リスクの説明、条件付きで軽微なUI修正の実施 |
| **Codex** | 実装・修正 | 仕様が明確な実装・修正、差分ベースのコード変更、JSロジック変更、複数ファイルにまたがる構造変更、小〜中規模の局所リファクタ |

### Claude の git 操作許可条件

Claude は原則として実装や git 操作を行わない。ただし、以下の条件を **すべて** 満たす場合に限り、`work/ai` ブランチでの commit / push を許可する。

1. 変更内容が表示・レイアウト・CSS調整のみ
2. 変更ファイル数が 2 ファイル以下
3. GAS / API / データ構造に影響しない
4. 既存仕様を変えない（見た目のみ）
5. 作業ブランチが `work/ai`
6. commit メッセージが以下の形式であること:
   ```
   fix(ui): 変更内容の要約（英語）
   ```

**条件を1つでも満たさない場合は、必ず「提案のみ」に留めること。**

### Codex の git 操作

Codex は人間の明示的な依頼がある場合のみ git 操作（commit / push）を行う。

### Codex への作業指示の受け渡し

Claude が Codex 向けの実装タスクを作成した場合、`codex-tasks/` フォルダにファイルとして出力する。

- 配置先: `codex-tasks/`
- ファイル名: `連番_要約.md`（例: `001_fix-header-overlap.md`）
- 人間がこのファイルを Codex に渡して実装を依頼する
- Codex は作業完了後、使用済みの指示書を削除してよい

#### 指示書の書き方ルール

指示書は**仕様・要件・制約**を伝えるものであり、**実装そのもの（コード）を書く場ではない**。

- **書くべきもの**: 要件、変更対象ファイル、データ構造の変更点、既存コードとの互換性の注意点、テスト確認項目、バージョン更新箇所
- **書かないもの**: 変更前後のコード全文、関数の完全な実装例
- **コード記載が許される場合**: データ構造やAPIインターフェースの定義など、仕様を正確に伝えるために必要最低限のコード片のみ
- **原則**: Codex が仕様を読んで自分で実装方法を判断できる粒度にする。コードを全部書いてしまうとCodexに実装を依頼する意味がなくなる

### 標準作業フロー

```
1. 調査・設計フェーズ（Claude）→ 要求の整理、仕様の明確化、変更方針の提示
                                → 必要に応じて codex-tasks/ に指示書を出力
2. 承認（人間）               → 方針の確認と実装の指示
                                → 指示書を Codex に渡す
3. 実装フェーズ（Codex）      → 指示書に基づくコード変更
4. 確認（人間）               → 結果の確認、必要に応じてフィードバック
```

※ 軽微なUI修正で Claude の git 操作許可条件をすべて満たす場合は、フェーズ1で直接修正・commit してよい。

すべてのフェーズ間で人間の確認・指示を挟む。AIがフェーズを飛ばして自走しないこと。

### 協業ルール

- **曖昧な要求や大きな設計変更は、必ずClaudeフェーズ（調査・設計整理）を先に挟む**。Codexが曖昧な要求を受けた場合は、実装に入らずユーザーに確認を求める
- **実装作業はCodexが担当することを前提とする**。Claudeは上記の許可条件を満たす軽微な修正以外のコード変更は行わない
- **各AIは自分の担当役割を越境しない**。Claudeが独自判断で大規模実装を行わない。Codexが設計判断を独自に行わない
- **判断に迷う場合は、作業を止めてユーザーに確認する**

---

## 作業ルール

### してよいこと

- 指示された機能追加・バグ修正・改善の実施
- 既存のコードスタイル・パターンに合わせた変更
- 変更対象ファイルの事前読み込みによる影響範囲の確認
- `work/ai` ブランチへのcommit（Claude は上記「git操作許可条件」を満たす場合のみ。Codex は人間の明示的な依頼がある場合のみ）

### してはいけないこと

- **main ブランチへの直接 push**（`work/ai` ブランチでのみ作業する）
- **フレームワーク・ライブラリ・ビルドツールの導入**（Vanilla JS構成を維持する）
- **認証機能の追加提案**（評価済み・見送り済み）
- **GASの新規デプロイ作成の指示**（URLが変わり、全端末で再設定が必要になる）
- **依頼されていない機能追加やリファクタリング**
- **フロントとGASの責務境界の変更**（下記参照）
- **自分の担当役割の越境**（上記「AI協業モデル」参照。特に、Claude は許可条件を満たさないコード変更の commit を行わないこと）

### フロントエンドとGASの責務分離

| 責務 | 担当 |
|------|------|
| UI表示・ユーザー操作・ローカルキャッシュ・画像圧縮 | フロントエンド（js/app.js） |
| データのCRUD・スプレッドシート操作・Drive画像管理 | GAS（gas/Code.gs） |

この境界を変更しないこと（例: GAS側にUI生成ロジックを入れない。フロント側からスプレッドシートに直接アクセスしない）。

### 変更時の注意事項

- **影響範囲の確認**: 変更前に対象ファイルを読み、既存の動作を理解する。複数ファイルにまたがる変更や、既存動作が変わる可能性がある場合は、作業前にユーザーに方針を確認する
- **差分は最小限に**: 依頼された内容に直接関係しないコードを変更しない
- **バージョン番号の更新**: フロントエンドを変更したら、以下の **すべて** を同じバージョンに揃えること:
  1. `index.html` 内の `app.js?v=X.X.X`（キャッシュ対策）
  2. `index.html` 内の `styles.css?v=X.X.X`（キャッシュ対策）
  3. `index.html` 内のユーザー向けバージョン表記（ポータル下部 `.version-footer` と設定画面 `.app-version`）
  4. `AI_WORK_CONTEXT.md` 内の「現在のバージョン」
- **GAS変更時の注意**: Code.gs を変更した場合、ユーザーがGASエディタで「デプロイを管理」→「既存デプロイを編集」→「新バージョン」で更新する必要がある旨を伝える。「新しいデプロイ」を作成するとURLが変わるため絶対に指示しない

### ドキュメント更新ルール

作業完了時に以下を更新すること。

| ファイル | 更新タイミング |
|----------|----------------|
| CURRENT_STATUS.md | 機能追加・バグ修正・変更のたびに（作業履歴の追記、課題状態の更新） |
| PROJECT_CONTEXT.md | アーキテクチャ・構成が変わった場合のみ |
| AI_WORK_CONTEXT.md | バージョン番号・フェーズ・ルール変更があった場合のみ |

---

## 現在の状態（フェーズ）

- 全基本機能は実装済み・動作確認済み
- ローカルキャッシュ（localStorage）と楽観的UI更新はv2.2で導入済み
- 現フェーズ: **安定運用中。大規模リファクタは未着手**
- 安定稼働を最優先とし、破壊的変更は避ける

## 未対応の改善候補（優先度順）

以下は認識されている改善候補であり、ユーザーから指示があった場合のみ着手する。

1. エラーハンドリングの整理（リトライ処理、具体的なエラーメッセージ）
2. 重複リクエスト防止（ボタン連打対策）
3. UI/UXの微調整
4. オフライン時の挙動改善（Service Worker）

---

> 最終更新: 2026年2月9日
