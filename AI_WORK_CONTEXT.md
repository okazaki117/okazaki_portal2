# AI_WORK_CONTEXT.md

> **このファイルは、AIエージェント（Antigravity）が作業する際のコンテキストです。**
> 作業開始時に必ず最初に読んでください。
>
> **最終責任者・意思決定者はユーザー（人間）です。** AIは判断材料の提示と作業の実行を担い、最終判断はすべてユーザーが行います。

---

## プロジェクト概要

- アプリ名: 家族ポータル
- リポジトリ: okazaki_portal2
- ホスティング: GitHub Pages（静的ファイルのみ。データは一切含まない）
- 現在のバージョン: v2.5.4

## 技術スタック

| レイヤー | 技術 | 補足 |
|----------|------|------|
| フロントエンド | HTML / CSS / Vanilla JS | フレームワーク不使用。ビルドツール不使用 |
| PWA | manifest.json | ホーム画面追加対応（standalone） |
| バックエンドAPI | Google Apps Script（Webアプリ） | doGet / doPost でリクエスト処理 |
| データ保存 | Google スプレッドシート | シート: Memos / Wishes / Shopping / Settings |
| 画像保存 | Google Drive | fileId をスプレッドシートに保存。GAS経由でBase64取得 |

## ファイル構成

```
okazaki_portal2/
├── index.html            # メインHTML（SPA。全画面をここに含む）
├── manifest.json         # PWAマニフェスト
├── js/app.js             # 全JavaScript
├── css/styles.css        # 全スタイル
├── gas/Code.gs           # GASに貼り付けるコード（このリポジトリ内はコピー）
├── icons/                # PWAアイコン
├── codex-tasks/          # 旧環境の作業指示書置き場（現在は不使用）
├── AI_WORK_CONTEXT.md    # ← このファイル（AI共通コンテキスト）
├── PROJECT_CONTEXT.md    # アーキテクチャ・設計方針の詳細
├── CURRENT_STATUS.md     # 実装状況・課題・作業履歴
├── SETUP.md              # セットアップ手順（スプレッドシートID等の実値あり）
└── RESUME_PROMPT.md      # AI向け再開用プロンプト集
```

## セキュリティモデル

- 認証機能はない（評価の結果、夫婦2人用途では過剰と判断し見送り済み）
- GitHub Pages上にデータは一切ない（HTML/CSS/JSのみ）
- GAS WebアプリURLを知っている人だけがデータにアクセスできる設計
- スプレッドシート・Google Driveは非公開（GAS経由でのみアクセス）

## iPhone Safari固有の技術制約

これらを知らずにコードを変更すると動作が壊れるため、必ず意識すること。

- **CORS回避**: POSTリクエストは `Content-Type: text/plain` を使用する（application/json はプリフライトが発生し、GASが対応できない）
- **画像アップロード**: 必ずPOSTで送信する（GETだとBase64がURL長制限を超える）
- **通常のAPI呼び出し**: GETを使用する（キャッシュ効率のため）
- **GAS側のPOST受信**: `e.postData.contents` を `JSON.parse` してパースする

---

## AI作業モデル

### 役割分担

| 担当 | 役割 | 具体的な作業内容 |
|------|------|-----------------|
| **人間（ユーザー）** | 方針決定・最終判断 | 要求の発行、方針の承認、本番反映の判断、最終責任 |
| **Antigravity** | 一気通貫の実装 | 調査、設計提案、ユーザー承認後の直接実装、検証、ドキュメント保守まで単独で完結 |

### git 操作に関するルール（ブランチ運用）

個人開発であるため**基本的に `main` ブランチへの直接 commit / push を許可**します。
設計方針や実装内容についてユーザーの合意を得た後（または明確な指示がある場合）、直接 `main` ブランチへ commit / push して構いません。

**【重要】確実なコミットとプッシュの手順（ベストプラクティス）**
エラーの空振りや同期漏れを防ぐため、AIが操作する際は以下の手順を厳守すること：
1. **コマンドを分割して1つずつ実行する**: `git add .`、`git commit -m "..."`、`git push origin main` は `&&` 等で繋がず、別のコマンド実行アクションとして1つずつ実行する。
2. **実行完了を待つ**: 各ステップごとに実行完了（ステータス確認）を待ち、成功してから次のステップに進むこと。

### 標準作業フロー

```text
1. 調査・設計フェーズ         → 要求の整理、影響範囲の確認、仕様の明確化、変更方針の提示
2. 承認（人間）               → 方針の確認と実装の指示
3. 実装フェーズ               → 直接コード変更
4. 確認・検証（人間）         → ブラウザ等での動作確認と最終チェック
```

- **曖昧な要求や大きな設計変更は、必ず調査・設計フェーズを先に挟み、ユーザーの承認を得ること**。
- 軽微なバグ修正や仕様が完全に明確な追加機能などは、直接実装フェーズに入ってもよい。
- **判断に迷う場合や実装リスクがある場合は、必ず作業を止めてユーザーに確認する**。

---

## 作業ルール

### してよいこと

- 指示された機能追加・バグ修正・改善の実施
- 既存のコードスタイル・パターンに合わせた変更
- 変更対象ファイルの事前読み込みによる影響範囲の確認
- `main` ブランチへの直接 commit / push

### してはいけないこと

- **フレームワーク・ライブラリ・ビルドツールの導入**（Vanilla JS構成を維持する）
- **認証機能の追加提案**（評価済み・見送り済み）
- **GASの新規デプロイ作成の指示**（URLが変わり、全端末で再設定が必要になる）
- **依頼されていない機能追加や大規模なリファクタリング**
- **フロントとGASの責務境界の変更**（下記参照）
- **独断での仕様変更**（必ず事前にユーザーに確認すること）

### フロントエンドとGASの責務分離

| 責務 | 担当 |
|------|------|
| UI表示・ユーザー操作・ローカルキャッシュ・画像圧縮 | フロントエンド（js/app.js） |
| データのCRUD・スプレッドシート操作・Drive画像管理 | GAS（gas/Code.gs） |

この境界を変更しないこと（例: GAS側にUI生成ロジックを入れない。フロント側からスプレッドシートに直接アクセスしない）。

### 変更時の注意事項

- **影響範囲の確認**: 変更前に対象ファイルを読み、既存の動作を理解する。複数ファイルにまたがる変更や、既存動作が変わる可能性がある場合は、作業前にユーザーに方針を確認する
- **差分は最小限に**: 依頼された内容に直接関係しないコードを変更しない
- **バージョン番号の更新**: フロントエンドを変更したら、以下の **すべて** を同じバージョンに揃えること:
  1. `index.html` 内の `app.js?v=X.X.X`（キャッシュ対策）
  2. `index.html` 内の `styles.css?v=X.X.X`（キャッシュ対策）
  3. `index.html` 内のユーザー向けバージョン表記（ポータル下部 `.version-footer` と設定画面 `.app-version`）
  4. `AI_WORK_CONTEXT.md` 内の「現在のバージョン」
- **GAS変更時の注意**: Code.gs を変更した場合、ユーザーがGASエディタで「デプロイを管理」→「既存デプロイを編集」→「新バージョン」で更新する必要がある旨を伝える。「新しいデプロイ」を作成するとURLが変わるため絶対に指示しない

### ドキュメント更新ルール

作業完了時に以下を更新すること。

| ファイル | 更新タイミング |
|----------|----------------|
| CURRENT_STATUS.md | 機能追加・バグ修正・変更のたびに（作業履歴の追記、課題状態の更新） |
| PROJECT_CONTEXT.md | アーキテクチャ・構成が変わった場合のみ |
| AI_WORK_CONTEXT.md | バージョン番号・フェーズ・ルール変更があった場合のみ |

---

## 現在の状態（フェーズ）

- 全基本機能は実装済み・動作確認済み
- ローカルキャッシュ（localStorage）と楽観的UI更新はv2.2で導入済み
- 現フェーズ: **安定運用中。大規模リファクタは未着手**
- 安定稼働を最優先とし、破壊的変更は避ける

## 未対応の改善候補（優先度順）

以下は認識されている改善候補であり、ユーザーから指示があった場合のみ着手する。

1. エラーハンドリングの整理（リトライ処理、具体的なエラーメッセージ）
2. 重複リクエスト防止（ボタン連打対策）
3. UI/UXの微調整
4. オフライン時の挙動改善（Service Worker）

---

> 最終更新: 2026年2月22日
