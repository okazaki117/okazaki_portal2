# AI_WORK_CONTEXT.md

> **このファイルは、複数のAI（Claude Code / OpenAI Codex / ChatGPT）が交互に作業する際の唯一の共通コンテキストです。**
> 作業開始時に必ず最初に読んでください。

---

## プロジェクト概要

- アプリ名: 家族ポータル
- リポジトリ: okazaki_portal2
- 目的: 夫婦2人専用のシンプルな情報共有PWA
- ホスティング: GitHub Pages（静的ファイルのみ。データは一切含まない）
- 現在のバージョン: v2.2.3

## 技術スタック

| レイヤー | 技術 | 補足 |
|----------|------|------|
| フロントエンド | HTML / CSS / Vanilla JS | フレームワーク不使用。ビルドツール不使用 |
| PWA | manifest.json | ホーム画面追加対応（standalone） |
| バックエンドAPI | Google Apps Script（Webアプリ） | doGet / doPost でリクエスト処理 |
| データ保存 | Google スプレッドシート | シート: Memos / Wishes / Shopping / Settings |
| 画像保存 | Google Drive | fileId をスプレッドシートに保存。GAS経由でBase64取得 |

## ファイル構成

```
okazaki_portal2/
├── index.html            # メインHTML（SPA。全画面をここに含む）
├── manifest.json         # PWAマニフェスト
├── js/app.js             # 全JavaScript
├── css/styles.css        # 全スタイル
├── gas/Code.gs           # GASに貼り付けるコード（このリポジトリ内はコピー）
├── icons/                # PWAアイコン
├── AI_WORK_CONTEXT.md    # ← このファイル（AI共通コンテキスト）
├── PROJECT_CONTEXT.md    # アーキテクチャ・設計方針の詳細
├── CURRENT_STATUS.md     # 実装状況・課題・作業履歴
├── SETUP.md              # セットアップ手順（スプレッドシートID等の実値あり）
└── RESUME_PROMPT.md      # AI向け再開用プロンプト集
```

## セキュリティモデル

- 認証機能はない（評価の結果、夫婦2人用途では過剰と判断し見送り済み）
- GitHub Pages上にデータは一切ない（HTML/CSS/JSのみ）
- GAS WebアプリURLを知っている人だけがデータにアクセスできる設計
- スプレッドシート・Google Driveは非公開（GAS経由でのみアクセス）

## iPhone Safari固有の技術制約

これらを知らずにコードを変更すると動作が壊れるため、必ず意識すること。

- **CORS回避**: POSTリクエストは `Content-Type: text/plain` を使用する（application/json はプリフライトが発生し、GASが対応できない）
- **画像アップロード**: 必ずPOSTで送信する（GETだとBase64がURL長制限を超える）
- **通常のAPI呼び出し**: GETを使用する（キャッシュ効率のため）
- **GAS側のPOST受信**: `e.postData.contents` を `JSON.parse` してパースする

---

## 作業ルール

### してよいこと

- 指示された機能追加・バグ修正・改善の実施
- 既存のコードスタイル・パターンに合わせた変更
- 変更対象ファイルの事前読み込みによる影響範囲の確認
- `work/ai` ブランチへのcommit

### してはいけないこと

- **main ブランチへの直接 push**（`work/ai` ブランチでのみ作業する）
- **フレームワーク・ライブラリ・ビルドツールの導入**（Vanilla JS構成を維持する）
- **認証機能の追加提案**（評価済み・見送り済み）
- **GASの新規デプロイ作成の指示**（URLが変わり、全端末で再設定が必要になる）
- **依頼されていない機能追加やリファクタリング**
- **フロントとGASの責務境界の変更**（下記参照）

### フロントエンドとGASの責務分離

| 責務 | 担当 |
|------|------|
| UI表示・ユーザー操作・ローカルキャッシュ・画像圧縮 | フロントエンド（js/app.js） |
| データのCRUD・スプレッドシート操作・Drive画像管理 | GAS（gas/Code.gs） |

この境界を変更しないこと（例: GAS側にUI生成ロジックを入れない。フロント側からスプレッドシートに直接アクセスしない）。

### 変更時の注意事項

- **影響範囲の確認**: 変更前に対象ファイルを読み、既存の動作を理解する。複数ファイルにまたがる変更や、既存動作が変わる可能性がある場合は、作業前にユーザーに方針を確認する
- **差分は最小限に**: 依頼された内容に直接関係しないコードを変更しない
- **バージョン番号の更新**: フロントエンドを変更したら、index.html 内の `app.js?v=X.X.X` と `styles.css?v=X.X.X` のバージョンを上げる（ブラウザキャッシュ対策）
- **GAS変更時の注意**: Code.gs を変更した場合、ユーザーがGASエディタで「デプロイを管理」→「既存デプロイを編集」→「新バージョン」で更新する必要がある旨を伝える。「新しいデプロイ」を作成するとURLが変わるため絶対に指示しない

### ドキュメント更新ルール

作業完了時に以下を更新すること。

| ファイル | 更新タイミング |
|----------|----------------|
| CURRENT_STATUS.md | 機能追加・バグ修正・変更のたびに（作業履歴の追記、課題状態の更新） |
| PROJECT_CONTEXT.md | アーキテクチャ・構成が変わった場合のみ |
| AI_WORK_CONTEXT.md | バージョン番号・フェーズ・ルール変更があった場合のみ |

---

## 現在の状態（フェーズ）

- 全基本機能は実装済み・動作確認済み
- ローカルキャッシュ（localStorage）と楽観的UI更新はv2.2で導入済み
- 現フェーズ: **安定運用中。大規模リファクタは未着手**
- 安定稼働を最優先とし、破壊的変更は避ける

## 未対応の改善候補（優先度順）

以下は認識されている改善候補であり、ユーザーから指示があった場合のみ着手する。

1. エラーハンドリングの整理（リトライ処理、具体的なエラーメッセージ）
2. 重複リクエスト防止（ボタン連打対策）
3. UI/UXの微調整
4. オフライン時の挙動改善（Service Worker）

---

> 最終更新: 2025年2月9日
